<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- Login Section -->
    <div id="auth-section">
        <h1>Admin Login</h1>
        <div id="auth-message"></div>
        <input type="email" id="login-email" placeholder="Admin Email">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-section" style="display:none">
        <h1>Deposit Management <button onclick="handleLogout()">Logout</button></h1>
        <div id="admin-message"></div>
        <div id="loading">Loading deposits...</div>
        <div id="deposits-list"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCAfsKcVP7OUo870TKkBnk4BfDEq9LnAK8",
            authDomain: "newporoject-c6f66.firebaseapp.com",
            databaseURL: "https://newporoject-c6f66-default-rtdb.firebaseio.com",
            projectId: "newporoject-c6f66",
            storageBucket: "newporoject-c6f66.appspot.com",
            messagingSenderId: "733557611631",
            appId: "1:733557611631:web:02c9377f56d614ff3b019a",
            measurementId: "G-53BEVW33FP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const adminSection = document.getElementById('admin-section');
        const authMessage = document.getElementById('auth-message');
        const adminMessage = document.getElementById('admin-message');
        const loadingElement = document.getElementById('loading');
        const depositsList = document.getElementById('deposits-list');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');

        // Login Function
        function handleLogin() {
            const email = loginEmail.value;
            const password = loginPassword.value;

            if (!email || !password) {
                authMessage.textContent = 'Please enter email and password';
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return userCredential.user.getIdTokenResult();
                })
                .then((idTokenResult) => {
                    if (idTokenResult.claims.admin) {
                        authSection.style.display = 'none';
                        adminSection.style.display = 'block';
                        loadDeposits();
                    } else {
                        auth.signOut();
                        authMessage.textContent = 'Admin access required';
                    }
                })
                .catch((error) => {
                    authMessage.textContent = 'Login failed: ' + error.message;
                });
        }

        // Logout Function
        function handleLogout() {
            auth.signOut()
                .then(() => {
                    adminSection.style.display = 'none';
                    authSection.style.display = 'block';
                    depositsList.innerHTML = '';
                });
        }

        // Load Deposits
        function loadDeposits() {
            loadingElement.style.display = 'block';
            depositsList.innerHTML = '';

            database.ref('deposits').on('value', (snapshot) => {
                loadingElement.style.display = 'none';
                const deposits = snapshot.val();

                if (!deposits) {
                    depositsList.innerHTML = 'No deposits found';
                    return;
                }

                depositsList.innerHTML = '';
                Object.entries(deposits).forEach(([depositId, deposit]) => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <h3>Deposit ${depositId}</h3>
                        <p>User: ${deposit.userId || 'N/A'}</p>
                        <p>Amount: ${deposit.amount || '0'}</p>
                        <p>Status: ${deposit.status || 'pending'}</p>
                        <button onclick="approveDeposit('${depositId}')">Approve</button>
                        <button onclick="rejectDeposit('${depositId}')">Reject</button>
                        <hr>
                    `;
                    depositsList.appendChild(div);
                });
            }, (error) => {
                loadingElement.style.display = 'none';
                adminMessage.textContent = 'Error loading deposits: ' + error.message;
            });
        }

        // Approve Deposit
        function approveDeposit(depositId) {
            if (confirm('Approve this deposit?')) {
                database.ref(`deposits/${depositId}`).update({
                    status: 'approved',
                    processedAt: Date.now()
                });
            }
        }

        // Reject Deposit
        function rejectDeposit(depositId) {
            if (confirm('Reject this deposit?')) {
                database.ref(`deposits/${depositId}`).update({
                    status: 'rejected',
                    processedAt: Date.now()
                });
            }
        }

        // Check auth state on load
        auth.onAuthStateChanged((user) => {
            if (user) {
                user.getIdTokenResult().then((idTokenResult) => {
                    if (idTokenResult.claims.admin) {
                        authSection.style.display = 'none';
                        adminSection.style.display = 'block';
                        loadDeposits();
                    }
                });
            }
        });
    </script>
</body>
</html>
