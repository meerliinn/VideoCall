<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - VideoCall</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .alert-error { background-color: #f8d7da; color: #721c24; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; }
    .alert-warning { background-color: #fff3cd; color: #856404; }
    .alert-success { background-color: #d4edda; color: #155724; }
    #loadingIndicator { margin: 20px 0; font-weight: bold; }
    .deposit-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <h2>Pending Deposits</h2>
  
  <div id="loadingIndicator" style="display:none;">
    Loading deposits...
  </div>
  
  <div id="errorMessage" class="alert" style="display:none;"></div>
  
  <div id="depositsContainer">
    <!-- Deposits will be loaded here -->
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCAfsKcVP7OUo870TKkBnk4BfDEq9LnAK8",
      authDomain: "newporoject-c6f66.firebaseapp.com",
      databaseURL: "https://newporoject-c6f66-default-rtdb.firebaseio.com",
      projectId: "newporoject-c6f66",
      storageBucket: "newporoject-c6f66.appspot.com",
      messagingSenderId: "733557611631",
      appId: "1:733557611631:web:02c9377f56d614ff3b019a",
      measurementId: "G-53BEVW33FP"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // DOM Elements
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const depositsContainer = document.getElementById('depositsContainer');

    // Show message function
    function showMessage(message, type = 'error') {
      errorMessage.textContent = message;
      errorMessage.className = `alert alert-${type}`;
      errorMessage.style.display = 'block';
    }

    // Hide message function
    function hideMessage() {
      errorMessage.style.display = 'none';
    }

    // Show loading indicator
    function showLoading(state) {
      loadingIndicator.style.display = state ? 'block' : 'none';
    }

    // Format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    // Render deposit items
    function renderDeposits(deposits) {
      depositsContainer.innerHTML = '';
      
      if (!deposits || Object.keys(deposits).length === 0) {
        showMessage('No pending deposits found', 'info');
        return;
      }
      
      hideMessage();
      
      Object.entries(deposits).forEach(([key, deposit]) => {
        const depositItem = document.createElement('div');
        depositItem.className = 'deposit-item';
        depositItem.innerHTML = `
          <h3>Deposit ID: ${key}</h3>
          <p><strong>Amount:</strong> ${deposit.amount || 'N/A'}</p>
          <p><strong>User:</strong> ${deposit.userId || 'N/A'}</p>
          <p><strong>Submitted:</strong> ${formatDate(deposit.timestamp)}</p>
          <p><strong>Status:</strong> ${deposit.status || 'pending'}</p>
          <button onclick="processDeposit('${key}')">Process Deposit</button>
        `;
        depositsContainer.appendChild(depositItem);
      });
    }

    // Process deposit function
    function processDeposit(depositId) {
      if (!confirm('Are you sure you want to process this deposit?')) return;
      
      showLoading(true);
      database.ref(`deposits/${depositId}/status`).set('processed')
        .then(() => {
          showMessage('Deposit processed successfully!', 'success');
          loadDeposits();
        })
        .catch(error => {
          console.error('Error processing deposit:', error);
          showMessage('Error processing deposit. Please try again.');
        })
        .finally(() => {
          showLoading(false);
        });
    }

    // Load deposits function
    function loadDeposits() {
      showLoading(true);
      hideMessage();
      
      try {
        const depositsRef = database.ref('deposits');
        
        depositsRef.orderByChild('status').equalTo('pending').on('value', (snapshot) => {
          try {
            const data = snapshot.val();
            renderDeposits(data);
          } catch (error) {
            console.error('Data processing error:', error);
            showMessage('Error processing deposits data');
          } finally {
            showLoading(false);
          }
        }, (error) => {
          console.error('Database read error:', error);
          showMessage('Error loading deposits from database');
          showLoading(false);
        });
      } catch (error) {
        console.error('Function error:', error);
        showMessage('System error while loading deposits');
        showLoading(false);
      }
    }

    // Check authentication and load data
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Verify admin status (you may need to implement custom claims)
        user.getIdTokenResult().then((idTokenResult) => {
          if (idTokenResult.claims.admin) {
            // Monitor connection state
            database.ref('.info/connected').on('value', (snapshot) => {
              if (snapshot.val() === true) {
                console.log('Connected to Firebase');
                loadDeposits();
              } else {
                console.log('Not connected to database');
                showMessage('Connection lost. Trying to reconnect...', 'warning');
              }
            });
          } else {
            showMessage('You do not have admin privileges', 'error');
            setTimeout(() => {
              auth.signOut();
              window.location.href = 'login.html';
            }, 3000);
          }
        });
      } else {
        window.location.href = 'login.html';
      }
    });

    // Make processDeposit available globally
    window.processDeposit = processDeposit;
  </script>
</body>
</html>
