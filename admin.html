<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5 }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fff; border-radius: 5px }
        button { padding: 5px 10px; margin-right: 5px; cursor: pointer; border-radius: 3px }
        .approve { background: #4CAF50; color: white; border: none }
        .reject { background: #f44336; color: white; border: none }
        .primary { background: #2196F3; color: white; border: none }
        .warning { background: #FF9800; color: white; border: none }
        img { max-width: 300px; display: block; margin-top: 5px; border: 1px solid #eee }
        h1 { color: #333 }
        h2 { color: #444; margin-top: 30px }
        .user-info { margin-bottom: 5px }
        .timestamp { color: #666; font-size: 12px }
        .status-pending { color: #FF9800 }
        .status-approved { color: #4CAF50 }
        .status-rejected { color: #f44336 }
        .section-divider { 
            margin: 40px 0 20px 0; 
            border-top: 2px solid #ddd; 
            padding-top: 20px 
        }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        .balance-control { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px;
        }
        .tabs { display: flex; margin-bottom: 15px; }
        .tab { 
            padding: 10px 15px; 
            cursor: pointer; 
            background: #eee; 
            margin-right: 5px; 
            border-radius: 5px 5px 0 0;
        }
        .tab.active { background: #fff; border: 1px solid #ddd; border-bottom: 1px solid #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .referral-list { max-height: 500px; overflow-y: auto; }
        .referral-item { padding: 10px; border-bottom: 1px solid #eee; }
        .referral-item:hover { background: #f9f9f9; }
        .tree-node { margin-left: 20px; }
        .tree-toggle { cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="admin-panel">
        <h1>Admin Control Panel</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('balance-control')">Balance Control</div>
            <div class="tab" onclick="switchTab('deposit-approvals')">Deposit Approvals</div>
            <div class="tab" onclick="switchTab('withdrawal-approvals')">Withdrawal Approvals</div>
            <div class="tab" onclick="switchTab('referral-network')">Referral Network</div>
        </div>
        
        <div id="balance-control" class="tab-content active">
            <div class="balance-control">
                <h2>User Balance Management</h2>
                <div class="form-group">
                    <label for="user-id">User ID</label>
                    <input type="text" id="user-id" placeholder="Enter user ID">
                </div>
                <div class="form-group">
                    <label for="balance-type">Balance Type</label>
                    <select id="balance-type">
                        <option value="depositBalance">Deposit Balance</option>
                        <option value="taskEarnings">Earnings Balance</option>
                        <option value="points">Points Balance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="balance-action">Action</label>
                    <select id="balance-action">
                        <option value="add">Add Balance</option>
                        <option value="subtract">Subtract Balance</option>
                        <option value="set">Set Balance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="balance-amount">Amount</label>
                    <input type="number" id="balance-amount" placeholder="Enter amount" step="0.01">
                </div>
                <div class="form-group">
                    <label for="balance-reason">Reason (Optional)</label>
                    <input type="text" id="balance-reason" placeholder="Enter reason for adjustment">
                </div>
                <button class="primary" onclick="adjustUserBalance()">Apply Balance Adjustment</button>
            </div>
            
            <div id="user-balance-info" style="margin-top: 20px; display: none;">
                <h3>Current Balances</h3>
                <div class="user-info"><strong>Deposit Balance:</strong> <span id="current-deposit">0</span> USDT</div>
                <div class="user-info"><strong>Earnings Balance:</strong> <span id="current-earnings">0</span> USDT</div>
                <div class="user-info"><strong>Points Balance:</strong> <span id="current-points">0</span> points</div>
            </div>
        </div>
        
        <div id="deposit-approvals" class="tab-content">
            <h2>Deposit Approvals</h2>
            <div id="deposits"></div>
        </div>
        
        <div id="withdrawal-approvals" class="tab-content">
            <h2>Withdrawal Approvals</h2>
            <div id="withdrawals"></div>
        </div>
        
        <div id="referral-network" class="tab-content">
            <h2>Referral Network</h2>
            <div class="form-group">
                <label for="referral-search">Search User</label>
                <input type="text" id="referral-search" placeholder="Enter user ID or email" onkeyup="searchReferralUser()">
            </div>
            <div id="referral-results"></div>
            <div id="referral-tree" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCAfsKcVP7OUo870TKkBnk4BfDEq9LnAK8",
            authDomain: "newporoject-c6f66.firebaseapp.com",
            databaseURL: "https://newporoject-c6f66-default-rtdb.firebaseio.com",
            projectId: "newporoject-c6f66",
            storageBucket: "newporoject-c6f66.appspot.com",
            messagingSenderId: "733557611631",
            appId: "1:733557611631:web:02c9377f56d614ff3b019a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        const db = firebase.firestore();

        // Load deposits and withdrawals immediately
        loadDeposits();
        loadWithdrawals();

        // Setup user ID input to fetch balances
        document.getElementById('user-id').addEventListener('change', function() {
            const userId = this.value.trim();
            if (userId) {
                fetchUserBalances(userId);
            } else {
                document.getElementById('user-balance-info').style.display = 'none';
            }
        });

        // Tab switching
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Fetch user balances
        function fetchUserBalances(userId) {
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('current-deposit').textContent = 
                            (userData.depositBalance || 0).toFixed(2);
                        document.getElementById('current-earnings').textContent = 
                            (userData.taskEarnings || 0).toFixed(2);
                        document.getElementById('current-points').textContent = 
                            userData.points || 0;
                        document.getElementById('user-balance-info').style.display = 'block';
                    } else {
                        alert('User not found');
                        document.getElementById('user-balance-info').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching user:', error);
                    alert('Error fetching user data');
                });
        }

        // Adjust user balance
        async function adjustUserBalance() {
            const userId = document.getElementById('user-id').value.trim();
            const balanceType = document.getElementById('balance-type').value;
            const action = document.getElementById('balance-action').value;
            const amount = parseFloat(document.getElementById('balance-amount').value);
            const reason = document.getElementById('balance-reason').value.trim();
            
            if (!userId) {
                alert('Please enter a user ID');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (!confirm(`Are you sure you want to ${action} ${amount} to ${balanceType} for user ${userId}?`)) {
                return;
            }
            
            try {
                const userRef = db.collection('users').doc(userId);
                const adjustment = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    adminId: firebase.auth().currentUser?.uid || 'system',
                    action: action,
                    amount: amount,
                    balanceType: balanceType,
                    reason: reason || 'No reason provided'
                };
                
                // First check if user exists
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // Create user if doesn't exist
                    const newUserData = {
                        depositBalance: balanceType === 'depositBalance' ? 
                            (action === 'set' ? amount : amount) : 0,
                        taskEarnings: balanceType === 'taskEarnings' ? 
                            (action === 'set' ? amount : amount) : 0,
                        points: balanceType === 'points' ? 
                            (action === 'set' ? amount : Math.round(amount)) : 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await userRef.set(newUserData);
                } else {
                    // Update existing user
                    let updateData = {};
                    
                    if (action === 'add') {
                        updateData[balanceType] = firebase.firestore.FieldValue.increment(
                            balanceType === 'points' ? Math.round(amount) : amount
                        );
                    } else if (action === 'subtract') {
                        updateData[balanceType] = firebase.firestore.FieldValue.increment(
                            balanceType === 'points' ? -Math.round(amount) : -amount
                        );
                    } else if (action === 'set') {
                        updateData[balanceType] = balanceType === 'points' ? Math.round(amount) : amount;
                    }
                    
                    await userRef.update(updateData);
                }
                
                // Record the adjustment in a separate collection for audit
                await db.collection('balanceAdjustments').add(adjustment);
                
                alert('Balance updated successfully!');
                fetchUserBalances(userId);
                document.getElementById('balance-amount').value = '';
                document.getElementById('balance-reason').value = '';
                
            } catch (error) {
                console.error('Error adjusting balance:', error);
                alert('Failed to adjust balance: ' + error.message);
            }
        }

        // Load deposits
        function loadDeposits() {
            rdb.ref('deposits').orderByChild('timestamp').on('value', snapshot => {
                const depositsDiv = document.getElementById('deposits');
                depositsDiv.innerHTML = '';
                
                if (!snapshot.exists()) {
                    depositsDiv.innerHTML = '<p>No pending deposits</p>';
                    return;
                }

                snapshot.forEach(child => {
                    const deposit = child.val();
                    const date = new Date(deposit.timestamp);
                    const statusClass = deposit.status === 'approved' ? 'status-approved' : 
                                      deposit.status === 'rejected' ? 'status-rejected' : 'status-pending';
                    
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <div class="user-info"><strong>User ID:</strong> ${deposit.userId}</div>
                        <div class="user-info"><strong>Email:</strong> ${deposit.userEmail || 'N/A'}</div>
                        <div class="user-info"><strong>Amount:</strong> $${deposit.amount} USDT</div>
                        <div class="user-info"><strong>TX Hash:</strong> ${deposit.transactionHash}</div>
                        <div class="user-info"><strong>Status:</strong> <span class="${statusClass}">${deposit.status || 'pending'}</span></div>
                        <div class="timestamp">${date.toLocaleString()}</div>
                        ${deposit.proofImage ? `<img src="${deposit.proofImage}" alt="Proof">` : ''}
                        <div style="margin-top:10px">
                            ${deposit.status !== 'approved' ? 
                                `<button class="approve" onclick="approveDeposit('${child.key}', '${deposit.userId}', ${deposit.amount})">
                                    Approve (+$${deposit.amount})
                                </button>` : ''}
                            
                            ${deposit.status !== 'rejected' ? 
                                `<button class="reject" onclick="rejectDeposit('${child.key}')">
                                    Reject
                                </button>` : ''}
                        </div>
                    `;
                    depositsDiv.appendChild(div);
                });
            });
        }

        // Load withdrawals
        function loadWithdrawals() {
            rdb.ref('withdrawals').orderByChild('timestamp').on('value', snapshot => {
                const withdrawalsDiv = document.getElementById('withdrawals');
                withdrawalsDiv.innerHTML = '';
                
                if (!snapshot.exists()) {
                    withdrawalsDiv.innerHTML = '<p>No pending withdrawals</p>';
                    return;
                }

                snapshot.forEach(child => {
                    const withdrawal = child.val();
                    const date = new Date(withdrawal.timestamp);
                    const statusClass = withdrawal.status === 'approved' ? 'status-approved' : 
                                      withdrawal.status === 'rejected' ? 'status-rejected' : 'status-pending';
                    
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <div class="user-info"><strong>User ID:</strong> ${withdrawal.userId}</div>
                        <div class="user-info"><strong>Email:</strong> ${withdrawal.userEmail || 'N/A'}</div>
                        <div class="user-info"><strong>Amount:</strong> $${withdrawal.amount} USDT</div>
                        <div class="user-info"><strong>Wallet Address:</strong> ${withdrawal.walletAddress}</div>
                        <div class="user-info"><strong>Status:</strong> <span class="${statusClass}">${withdrawal.status || 'pending'}</span></div>
                        <div class="timestamp">${date.toLocaleString()}</div>
                        <div style="margin-top:10px">
                            ${withdrawal.status !== 'approved' ? 
                                `<button class="approve" onclick="approveWithdrawal('${child.key}', '${withdrawal.userId}', ${withdrawal.amount})">
                                    Approve (Send $${withdrawal.amount})
                                </button>` : ''}
                            
                            ${withdrawal.status !== 'rejected' ? 
                                `<button class="reject" onclick="rejectWithdrawal('${child.key}')">
                                    Reject
                                </button>` : ''}
                        </div>
                    `;
                    withdrawalsDiv.appendChild(div);
                });
            });
        }

        // Search for referral user
        async function searchReferralUser() {
            const searchTerm = document.getElementById('referral-search').value.trim();
            if (!searchTerm) {
                document.getElementById('referral-results').innerHTML = '';
                return;
            }

            try {
                // Search by email or ID
                const snapshot = await db.collection('users')
                    .where('email', '==', searchTerm)
                    .get();

                if (snapshot.empty) {
                    // Try searching by ID
                    const userDoc = await db.collection('users').doc(searchTerm).get();
                    if (userDoc.exists) {
                        displayReferralUser(userDoc);
                    } else {
                        document.getElementById('referral-results').innerHTML = '<p>No user found</p>';
                    }
                } else {
                    snapshot.forEach(doc => {
                        displayReferralUser(doc);
                    });
                }
            } catch (error) {
                console.error('Error searching user:', error);
            }
        }

        // Display referral user info
        function displayReferralUser(userDoc) {
            const userData = userDoc.data();
            const resultsDiv = document.getElementById('referral-results');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <h3>User Info</h3>
                    <div class="user-info"><strong>ID:</strong> ${userDoc.id}</div>
                    <div class="user-info"><strong>Email:</strong> ${userData.email}</div>
                    <div class="user-info"><strong>Referral Code:</strong> ${userData.referralCode}</div>
                    <div class="user-info"><strong>Referred By:</strong> ${userData.referredBy || 'None'}</div>
                    <div class="user-info"><strong>Points:</strong> ${userData.points || 0}</div>
                    <div class="user-info"><strong>Invited Users:</strong> ${userData.invitedUsers?.length || 0}</div>
                    <button class="primary" onclick="loadReferralTree('${userDoc.id}')">View Network</button>
                </div>
            `;
        }

        // Load referral tree
        async function loadReferralTree(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) return;

                const userData = userDoc.data();
                let treeHTML = `
                    <div class="card">
                        <h3>Referral Network for ${userData.email}</h3>
                        <div class="user-info"><strong>Direct Referrals (${userData.invitedUsers?.length || 0})</strong></div>
                        <div class="referral-list" id="referral-list-${userId}"></div>
                    </div>
                `;

                document.getElementById('referral-tree').innerHTML = treeHTML;
                
                // Load direct referrals
                if (userData.invitedUsers && userData.invitedUsers.length > 0) {
                    const listElement = document.getElementById(`referral-list-${userId}`);
                    
                    for (const referral of userData.invitedUsers) {
                        const refUserDoc = await db.collection('users').doc(referral.userId).get();
                        if (refUserDoc.exists) {
                            const refData = refUserDoc.data();
                            const date = referral.date.toDate().toLocaleString();
                            
                            const div = document.createElement('div');
                            div.className = 'referral-item';
                            div.innerHTML = `
                                <div>
                                    <strong>${refData.email}</strong> (${date}) - ${referral.pointsEarned} points
                                    <button class="primary" style="padding: 2px 5px; font-size: 12px; margin-left: 10px;" 
                                        onclick="loadReferralTree('${referral.userId}')">View Downline</button>
                                </div>
                                <div id="downline-${referral.userId}" class="tree-node"></div>
                            `;
                            listElement.appendChild(div);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading referral tree:', error);
            }
        }

        // Approve deposit
        async function approveDeposit(depositId, userId, amount) {
            if (!confirm(`Approve $${amount} USDT deposit?`)) return;
            
            try {
                const userRef = db.collection('users').doc(userId);
                await userRef.update({
                    depositBalance: firebase.firestore.FieldValue.increment(parseFloat(amount))
                });
                
                await rdb.ref(`deposits/${depositId}`).update({ 
                    status: 'approved',
                    processedAt: Date.now()
                });
                
                alert('Deposit approved and balance updated!');
            } catch (error) {
                console.error(error);
                alert('Approval failed: ' + error.message);
            }
        }

        // Approve withdrawal (deducts from earnings balance)
        async function approveWithdrawal(withdrawalId, userId, amount) {
            if (!confirm(`Approve $${amount} USDT withdrawal? This will deduct from user's earnings balance.`)) return;
            
            try {
                const userRef = db.collection('users').doc(userId);
                await userRef.update({
                    taskEarnings: firebase.firestore.FieldValue.increment(-parseFloat(amount))
                });
                
                await rdb.ref(`withdrawals/${withdrawalId}`).update({ 
                    status: 'approved',
                    processedAt: Date.now()
                });
                
                alert('Withdrawal approved and balance updated!');
            } catch (error) {
                console.error(error);
                alert('Approval failed: ' + error.message);
            }
        }

        // Reject deposit
        function rejectDeposit(depositId) {
            if (confirm('Reject this deposit?')) {
                rdb.ref(`deposits/${depositId}`).update({ 
                    status: 'rejected',
                    processedAt: Date.now()
                });
            }
        }

        // Reject withdrawal
        function rejectWithdrawal(withdrawalId) {
            if (confirm('Reject this withdrawal request?')) {
                rdb.ref(`withdrawals/${withdrawalId}`).update({ 
                    status: 'rejected',
                    processedAt: Date.now()
                });
            }
        }
    </script>
</body>
</html>
