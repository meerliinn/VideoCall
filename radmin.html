<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Referral Program</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            margin: 0;
        }
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .primary {
            color: #3498db;
        }
        .success {
            color: #2ecc71;
        }
        .warning {
            color: #f39c12;
        }
        .danger {
            color: #e74c3c;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        .page-btn {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .page-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .no-data {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .user-details {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .user-details.active {
            display: block;
        }
        .close-details {
            float: right;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .export-btn {
            padding: 8px 15px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .export-btn:hover {
            background-color: #27ae60;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard - Referral Program</h1>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value primary" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value success" id="totalReferrals">0</div>
                <div class="stat-label">Total Referrals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="totalPoints">0</div>
                <div class="stat-label">Total Points Distributed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value danger" id="activeToday">0</div>
                <div class="stat-label">Active Today</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('referrals')">Referral Network</div>
            <div class="tab" onclick="openTab('users')">All Users</div>
            <div class="tab" onclick="openTab('topReferrers')">Top Referrers</div>
        </div>

        <div id="referrals-tab" class="tab-content active">
            <div class="search-container">
                <input type="text" class="search-input" id="referralSearch" placeholder="Search by referrer or referred user...">
                <button class="search-btn" onclick="searchReferrals()"><i class="fas fa-search"></i> Search</button>
                <button class="export-btn" onclick="exportReferrals()"><i class="fas fa-file-export"></i> Export</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Referrer</th>
                            <th>Referred User</th>
                            <th>Date</th>
                            <th>Points Earned</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="referralsTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="referralsPagination"></div>
        </div>

        <div id="users-tab" class="tab-content">
            <div class="search-container">
                <input type="text" class="search-input" id="userSearch" placeholder="Search users by name or email...">
                <button class="search-btn" onclick="searchUsers()"><i class="fas fa-search"></i> Search</button>
                <button class="export-btn" onclick="exportUsers()"><i class="fas fa-file-export"></i> Export</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Referral Code</th>
                            <th>Points</th>
                            <th>Referred By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="usersPagination"></div>
        </div>

        <div id="topReferrers-tab" class="tab-content">
            <div class="search-container">
                <input type="text" class="search-input" id="topReferrersSearch" placeholder="Search top referrers...">
                <button class="search-btn" onclick="searchTopReferrers()"><i class="fas fa-search"></i> Search</button>
                <button class="export-btn" onclick="exportTopReferrers()"><i class="fas fa-file-export"></i> Export</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Total Referrals</th>
                            <th>Total Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="topReferrersTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="topReferrersPagination"></div>
        </div>

        <div id="userDetails" class="user-details">
            <button class="close-details" onclick="closeUserDetails()">&times;</button>
            <h3 id="userDetailsName"></h3>
            <div id="userDetailsContent"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCAfsKcVP7OUo870TKkBnk4BfDEq9LnAK8",
            authDomain: "newporoject-c6f66.firebaseapp.com",
            databaseURL: "https://newporoject-c6f66-default-rtdb.firebaseio.com",
            projectId: "newporoject-c6f66",
            storageBucket: "newporoject-c6f66.appspot.com",
            messagingSenderId: "733557611631",
            appId: "1:733557611631:web:02c9377f56d614ff3b019a"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let allReferrals = [];
        let allUsers = [];
        let currentReferralsPage = 1;
        let currentUsersPage = 1;
        let currentTopReferrersPage = 1;
        const itemsPerPage = 10;

        // Initialize the admin dashboard
        async function initAdminDashboard() {
            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'sign.html';
                    return;
                }
                
                // Check if user is admin (you need to implement this check)
                const isAdmin = await checkIfAdmin(user.uid);
                if (!isAdmin) {
                    window.location.href = 'home.html';
                    return;
                }
                
                currentUser = user;
                loadStats();
                loadReferralsData();
                loadUsersData();
                loadTopReferrersData();
            });
            
            // Set up logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'sign.html';
                });
            });
        }

        // Check if user is admin (you need to implement your own admin check logic)
        

        // Load statistics
        async function loadStats() {
            try {
                // Total users
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                
                // Total referrals and points
                let totalReferrals = 0;
                let totalPoints = 0;
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.invitedUsers) {
                        totalReferrals += userData.invitedUsers.length;
                        totalPoints += userData.points || 0;
                    }
                });
                
                document.getElementById('totalReferrals').textContent = totalReferrals;
                document.getElementById('totalPoints').textContent = totalPoints;
                
                // Active today (users who logged in today)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const activeUsersSnapshot = await db.collection('users')
                    .where('lastLogin', '>=', today)
                    .get();
                
                document.getElementById('activeToday').textContent = activeUsersSnapshot.size;
                
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        // Load referral data
        async function loadReferralsData(searchTerm = '') {
            try {
                const referralsTableBody = document.getElementById('referralsTableBody');
                referralsTableBody.innerHTML = '<tr><td colspan="5" class="loading">Loading data...</td></tr>';
                
                const usersSnapshot = await db.collection('users').get();
                allReferrals = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.invitedUsers && userData.invitedUsers.length > 0) {
                        userData.invitedUsers.forEach(invitedUser => {
                            allReferrals.push({
                                referrerId: doc.id,
                                referrerName: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown',
                                referrerEmail: userData.email || '',
                                referredUserId: invitedUser.userId,
                                referredUserEmail: invitedUser.email || '',
                                date: invitedUser.date.toDate(),
                                pointsEarned: invitedUser.pointsEarned || 10
                            });
                        });
                    }
                });
                
                // Filter if search term exists
                let filteredReferrals = allReferrals;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredReferrals = allReferrals.filter(ref => 
                        ref.referrerName.toLowerCase().includes(term) ||
                        ref.referrerEmail.toLowerCase().includes(term) ||
                        ref.referredUserEmail.toLowerCase().includes(term)
                    );
                }
                
                // Sort by date (newest first)
                filteredReferrals.sort((a, b) => b.date - a.date);
                
                // Display data
                displayReferrals(filteredReferrals, currentReferralsPage);
                
                // Update pagination
                updatePagination(filteredReferrals.length, 'referrals');
                
            } catch (error) {
                console.error("Error loading referrals:", error);
                referralsTableBody.innerHTML = '<tr><td colspan="5" class="no-data">Error loading data. Please try again.</td></tr>';
            }
        }

        // Display referrals in table
        function displayReferrals(referrals, page) {
            const referralsTableBody = document.getElementById('referralsTableBody');
            
            if (referrals.length === 0) {
                referralsTableBody.innerHTML = '<tr><td colspan="5" class="no-data">No referral data found</td></tr>';
                return;
            }
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, referrals.length);
            const pageReferrals = referrals.slice(startIndex, endIndex);
            
            referralsTableBody.innerHTML = '';
            
            pageReferrals.forEach((ref, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${ref.referrerName}<br><small>${ref.referrerEmail}</small></td>
                    <td>${ref.referredUserEmail}</td>
                    <td>${ref.date.toLocaleString()}</td>
                    <td>${ref.pointsEarned}</td>
                    <td><button onclick="viewUserDetails('${ref.referredUserId}')">View Details</button></td>
                `;
                
                referralsTableBody.appendChild(row);
            });
        }

        // Load users data
        async function loadUsersData(searchTerm = '') {
            try {
                const usersTableBody = document.getElementById('usersTableBody');
                usersTableBody.innerHTML = '<tr><td colspan="6" class="loading">Loading data...</td></tr>';
                
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        name: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown',
                        email: userData.email || '',
                        referralCode: userData.referralCode || '',
                        points: userData.points || 0,
                        referredBy: userData.referredBy || ''
                    });
                });
                
                // Filter if search term exists
                let filteredUsers = allUsers;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredUsers = allUsers.filter(user => 
                        user.name.toLowerCase().includes(term) ||
                        user.email.toLowerCase().includes(term)
                    );
                }
                
                // Display data
                displayUsers(filteredUsers, currentUsersPage);
                
                // Update pagination
                updatePagination(filteredUsers.length, 'users');
                
            } catch (error) {
                console.error("Error loading users:", error);
                usersTableBody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading data. Please try again.</td></tr>';
            }
        }

        // Display users in table
        function displayUsers(users, page) {
            const usersTableBody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No users found</td></tr>';
                return;
            }
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, users.length);
            const pageUsers = users.slice(startIndex, endIndex);
            
            usersTableBody.innerHTML = '';
            
            pageUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.referralCode}</td>
                    <td>${user.points}</td>
                    <td>${user.referredBy ? 'Yes' : 'No'}</td>
                    <td><button onclick="viewUserDetails('${user.id}')">View Details</button></td>
                `;
                
                usersTableBody.appendChild(row);
            });
        }

        // Load top referrers data
        async function loadTopReferrersData(searchTerm = '') {
            try {
                const topReferrersTableBody = document.getElementById('topReferrersTableBody');
                topReferrersTableBody.innerHTML = '<tr><td colspan="6" class="loading">Loading data...</td></tr>';
                
                const usersSnapshot = await db.collection('users').get();
                let topReferrers = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const referralCount = userData.invitedUsers ? userData.invitedUsers.length : 0;
                    
                    if (referralCount > 0) {
                        topReferrers.push({
                            id: doc.id,
                            name: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown',
                            email: userData.email || '',
                            referralCount: referralCount,
                            points: userData.points || 0
                        });
                    }
                });
                
                // Sort by referral count (descending)
                topReferrers.sort((a, b) => b.referralCount - a.referralCount);
                
                // Filter if search term exists
                let filteredReferrers = topReferrers;
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredReferrers = topReferrers.filter(ref => 
                        ref.name.toLowerCase().includes(term) ||
                        ref.email.toLowerCase().includes(term)
                    );
                }
                
                // Display data
                displayTopReferrers(filteredReferrers, currentTopReferrersPage);
                
                // Update pagination
                updatePagination(filteredReferrers.length, 'topReferrers');
                
            } catch (error) {
                console.error("Error loading top referrers:", error);
                topReferrersTableBody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading data. Please try again.</td></tr>';
            }
        }

        // Display top referrers in table
        function displayTopReferrers(referrers, page) {
            const topReferrersTableBody = document.getElementById('topReferrersTableBody');
            
            if (referrers.length === 0) {
                topReferrersTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No top referrers found</td></tr>';
                return;
            }
            
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, referrers.length);
            const pageReferrers = referrers.slice(startIndex, endIndex);
            
            topReferrersTableBody.innerHTML = '';
            
            pageReferrers.forEach((referrer, index) => {
                const row = document.createElement('tr');
                const rank = startIndex + index + 1;
                
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${referrer.name}</td>
                    <td>${referrer.email}</td>
                    <td>${referrer.referralCount}</td>
                    <td>${referrer.points}</td>
                    <td><button onclick="viewUserDetails('${referrer.id}')">View Details</button></td>
                `;
                
                topReferrersTableBody.appendChild(row);
            });
        }

        // Update pagination controls
        function updatePagination(totalItems, type) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationId = `${type}Pagination`;
            const paginationContainer = document.getElementById(paginationId);
            
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '&laquo;';
            prevBtn.onclick = () => changePage(type, -1);
            prevBtn.disabled = getCurrentPage(type) === 1;
            paginationContainer.appendChild(prevBtn);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${getCurrentPage(type) === i ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(type, i);
                paginationContainer.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '&raquo;';
            nextBtn.onclick = () => changePage(type, 1);
            nextBtn.disabled = getCurrentPage(type) === totalPages;
            paginationContainer.appendChild(nextBtn);
        }

        // Get current page for a tab
        function getCurrentPage(type) {
            switch(type) {
                case 'referrals': return currentReferralsPage;
                case 'users': return currentUsersPage;
                case 'topReferrers': return currentTopReferrersPage;
                default: return 1;
            }
        }

        // Change page (increment/decrement)
        function changePage(type, delta) {
            let newPage;
            switch(type) {
                case 'referrals':
                    newPage = currentReferralsPage + delta;
                    if (newPage >= 1 && newPage <= Math.ceil(allReferrals.length / itemsPerPage)) {
                        currentReferralsPage = newPage;
                        displayReferrals(allReferrals, currentReferralsPage);
                        updatePagination(allReferrals.length, 'referrals');
                    }
                    break;
                case 'users':
                    newPage = currentUsersPage + delta;
                    if (newPage >= 1 && newPage <= Math.ceil(allUsers.length / itemsPerPage)) {
                        currentUsersPage = newPage;
                        displayUsers(allUsers, currentUsersPage);
                        updatePagination(allUsers.length, 'users');
                    }
                    break;
                case 'topReferrers':
                    newPage = currentTopReferrersPage + delta;
                    if (newPage >= 1 && newPage <= Math.ceil(allUsers.length / itemsPerPage)) {
                        currentTopReferrersPage = newPage;
                        loadTopReferrersData();
                    }
                    break;
            }
        }

        // Go to specific page
        function goToPage(type, page) {
            switch(type) {
                case 'referrals':
                    currentReferralsPage = page;
                    displayReferrals(allReferrals, currentReferralsPage);
                    updatePagination(allReferrals.length, 'referrals');
                    break;
                case 'users':
                    currentUsersPage = page;
                    displayUsers(allUsers, currentUsersPage);
                    updatePagination(allUsers.length, 'users');
                    break;
                case 'topReferrers':
                    currentTopReferrersPage = page;
                    loadTopReferrersData();
                    break;
            }
        }

        // View user details
        async function viewUserDetails(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                const name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown';
                
                document.getElementById('userDetailsName').textContent = name;
                
                // Build user details content
                let content = `
                    <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${userData.phone || 'N/A'}</p>
                    <p><strong>Referral Code:</strong> ${userData.referralCode || 'N/A'}</p>
                    <p><strong>Referred By:</strong> ${userData.referredBy || 'None'}</p>
                    <p><strong>Points:</strong> ${userData.points || 0}</p>
                    <p><strong>Account Created:</strong> ${userData.createdAt?.toDate().toLocaleString() || 'N/A'}</p>
                    <p><strong>Last Login:</strong> ${userData.lastLogin?.toDate().toLocaleString() || 'Never'}</p>
                `;
                
                // Add invited users if any
                if (userData.invitedUsers && userData.invitedUsers.length > 0) {
                    content += `<h4>Invited Users (${userData.invitedUsers.length})</h4><ul>`;
                    userData.invitedUsers.forEach(invited => {
                        content += `<li>${invited.email} - ${invited.date.toDate().toLocaleString()} (+${invited.pointsEarned || 10} points)</li>`;
                    });
                    content += '</ul>';
                }
                
                document.getElementById('userDetailsContent').innerHTML = content;
                document.getElementById('userDetails').classList.add('active');
                
            } catch (error) {
                console.error("Error viewing user details:", error);
                alert('Error loading user details');
            }
        }

        // Close user details
        function closeUserDetails() {
            document.getElementById('userDetails').classList.remove('active');
        }

        // Search functions
        function searchReferrals() {
            const searchTerm = document.getElementById('referralSearch').value;
            currentReferralsPage = 1;
            loadReferralsData(searchTerm);
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value;
            currentUsersPage = 1;
            loadUsersData(searchTerm);
        }

        function searchTopReferrers() {
            const searchTerm = document.getElementById('topReferrersSearch').value;
            currentTopReferrersPage = 1;
            loadTopReferrersData(searchTerm);
        }

        // Export functions
        function exportReferrals() {
            exportToCSV(allReferrals, 'referrals', [
                { header: 'Referrer Name', key: 'referrerName' },
                { header: 'Referrer Email', key: 'referrerEmail' },
                { header: 'Referred User Email', key: 'referredUserEmail' },
                { header: 'Date', key: 'date', format: (date) => date.toLocaleString() },
                { header: 'Points Earned', key: 'pointsEarned' }
            ]);
        }

        function exportUsers() {
            exportToCSV(allUsers, 'users', [
                { header: 'Name', key: 'name' },
                { header: 'Email', key: 'email' },
                { header: 'Referral Code', key: 'referralCode' },
                { header: 'Points', key: 'points' },
                { header: 'Referred By', key: 'referredBy' }
            ]);
        }

        function exportTopReferrers() {
            const topReferrers = allUsers
                .filter(user => user.points > 0)
                .sort((a, b) => b.points - a.points)
                .map((user, index) => ({
                    rank: index + 1,
                    name: user.name,
                    email: user.email,
                    referralCount: user.invitedUsers ? user.invitedUsers.length : 0,
                    points: user.points
                }));
                
            exportToCSV(topReferrers, 'top_referrers', [
                { header: 'Rank', key: 'rank' },
                { header: 'Name', key: 'name' },
                { header: 'Email', key: 'email' },
                { header: 'Total Referrals', key: 'referralCount' },
                { header: 'Total Points', key: 'points' }
            ]);
        }

        // Export data to CSV
        function exportToCSV(data, filename, columns) {
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create CSV header
            let csv = columns.map(col => col.header).join(',') + '\n';
            
            // Add data rows
            data.forEach(item => {
                const row = columns.map(col => {
                    const value = item[col.key];
                    if (col.format && typeof col.format === 'function') {
                        return `"${col.format(value)}"`;
                    }
                    return `"${value}"`;
                }).join(',');
                csv += row + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Tab switching
        function openTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Reset search inputs
            document.getElementById('referralSearch').value = '';
            document.getElementById('userSearch').value = '';
            document.getElementById('topReferrersSearch').value = '';
            
            // Reset pagination for the active tab
            switch(tabName) {
                case 'referrals':
                    currentReferralsPage = 1;
                    loadReferralsData();
                    break;
                case 'users':
                    currentUsersPage = 1;
                    loadUsersData();
                    break;
                case 'topReferrers':
                    currentTopReferrersPage = 1;
                    loadTopReferrersData();
                    break;
            }
        }

        // Initialize the dashboard when the page loads
        window.onload = initAdminDashboard;
    </script>
</body>
</html>
